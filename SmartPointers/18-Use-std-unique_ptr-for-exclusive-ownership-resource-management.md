#Item18:
å½“ä½ è¦ä½¿ç”¨ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆæ—¶ï¼Œé¦–å…ˆè¦æƒ³åˆ°çš„åº”è¯¥æ˜¯`std::unique_ptr`.ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ˆåˆç†çš„å‡è®¾:é»˜è®¤æƒ…å†µä¸‹ï¼Œ`std::unique_ptr`å’ŒåŸç”ŸæŒ‡é’ˆåŒç­‰å¤§å°ï¼Œå¯¹äºå¤§å¤šæ•°æ“ä½œ(åŒ…æ‹¬åå¼•ç”¨)ï¼Œå®ƒä»¬æ‰§è¡Œçš„åº•å±‚æŒ‡ä»¤ä¹Ÿä¸€æ ·ã€‚è¿™å°±æ„å‘³ç€ï¼Œå°½ç®¡åœ¨å†…å­˜å›æ”¶ç›´æ¥ç›´å¾€çš„æƒ…å†µä¸‹ï¼Œ`std::unique_ptr`ä¹Ÿè¶³ä»¥èƒœä»»åŸç”ŸæŒ‡é’ˆè½»å·§å¿«é€Ÿçš„ä½¿ç”¨è¦æ±‚ã€‚

`std::unique_ptr`å…·ç°äº†ç‹¬å (exclusive ownership)è¯­ä¹‰,ä¸€ä¸ªéç©ºçš„`std::unique_ptr`æ°¸è¿œæ‹¥æœ‰å®ƒæŒ‡å‘çš„å¯¹è±¡ï¼Œmoveä¸€ä¸ª`std::unique_ptr`ä¼šå°†æ‰€æœ‰æƒä»æºæŒ‡é’ˆè½¬å‘ç›®çš„æŒ‡é’ˆ(æºæŒ‡é’ˆæŒ‡å‘ä¸ºnull)ã€‚æ‹·è´ä¸€ä¸ª`std::unique_ptr`æ˜¯ä¸å…è®¸çš„ï¼Œå‡å¦‚è¯´çœŸçš„å¯ä»¥å…è®¸æ‹·è´`std::unique_ptr`,é‚£ä¹ˆå°†ä¼šæœ‰ä¸¤ä¸ª`std::unique_ptr`æŒ‡å‘åŒä¸€å—èµ„æºåŒºåŸŸï¼Œæ¯ä¸€ä¸ªéƒ½è®¤ä¸ºå®ƒè‡ªå·±æ‹¥æœ‰ä¸”å¯ä»¥æ‘§æ¯é‚£å—èµ„æºã€‚å› æ­¤ï¼Œ`std::unique_ptr`æ˜¯ä¸€ä¸ªmove-onlyç±»å‹ã€‚å½“å®ƒé¢ä¸´ææ„æ—¶ï¼Œä¸€ä¸ªéç©ºçš„`std::unique_ptr`ä¼šæ‘§æ¯å®ƒæ‰€æ‹¥æœ‰çš„èµ„æºã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`std::unique_ptr`ä¼šä½¿ç”¨deleteæ¥é‡Šæ”¾å®ƒæ‰€åŒ…è£¹çš„åŸç”ŸæŒ‡é’ˆæŒ‡å‘çš„ç©ºé—´ã€‚

`std::unique_ptr`çš„ä¸€ä¸ªå¸¸è§ç”¨æ³•æ˜¯ä½œä¸ºä¸€ä¸ªå·¥å‚å‡½æ•°è¿”å›ä¸€ä¸ªç»§æ‰¿å±‚çº§ä¸­çš„ä¸€ä¸ªç‰¹å®šç±»å‹çš„å¯¹è±¡ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæŠ•èµ„ç±»å‹çš„ç»§æ‰¿é“¾ã€‚

[18-1.png]

```cpp
class Investment { ... };    
class Stock:public Investment { ... };
class Bond:public Investment { ... };
class RealEstate:public Investment { ... };
``` 

ç”Ÿäº§è¿™ç§å±‚çº§å¯¹è±¡çš„å·¥å‚å‡½æ•°é€šå¸¸åœ¨å †ä¸Šé¢åˆ†é…ä¸€ä¸ªå¯¹è±¡å¹¶ä¸”è¿”å›ä¸€ä¸ªæŒ‡å‘å®ƒçš„æŒ‡é’ˆã€‚å½“ä¸å†éœ€è¦ä½¿ç”¨æ—¶ï¼Œè°ƒç”¨è€…æ¥å†³å®šæ˜¯å¦åˆ é™¤è¿™ä¸ªå¯¹è±¡ã€‚è¿™æ˜¯ä¸€ä¸ªç»ä½³çš„`std::unique_ptr`çš„ä½¿ç”¨åœºæ™¯ã€‚å› ä¸ºè°ƒç”¨è€…è·å¾—äº†ç”±å·¥å‚å‡½æ•°åˆ†é…çš„å¯¹è±¡çš„æ‰€æœ‰æƒ(å¹¶ä¸”æ˜¯ç‹¬å æ€§çš„)ï¼Œè€Œä¸”`std::unique_ptr`åœ¨è‡ªå·±å³å°†è¢«é”€æ¯æ—¶ï¼Œè‡ªåŠ¨é”€æ¯å®ƒæ‰€æŒ‡å‘çš„ç©ºé—´ã€‚ä¸€ä¸ªä¸ºInvestmentå±‚çº§å¯¹è±¡è®¾è®¡çš„å·¥å‚å‡½æ•°å¯ä»¥å£°æ˜å¦‚ä¸‹ï¼š

```cpp
template<typename... Ts> 
std::unique_ptr<Investment> makeInvestment(Ts&&... params);// return std::unique_ptr
    // to an object created
    // from the given args
```
è°ƒç”¨è€…å¯ä»¥åœ¨ä¸€å¤„ä»£ç å—ä¸­ä½¿ç”¨è¿”å›çš„`std::unique_ptr`:

```cpp
{
	...
	auto pInvestment = makeInvestment( arguments ); 
	//pInvestment is of type std::unique_ptr<Investment>
	...
}//destroy *pInvestment
``` 
    
ä»–ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨åœ¨æ‹¥æœ‰æƒè½¬ç§»çš„åœºæ™¯ä¸­ï¼Œä¾‹å¦‚å½“å·¥å‚å‡½æ•°è¿”å›çš„`std::unique_ptr`å¯ä»¥ç§»åŠ¨åˆ°ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œè¿™ä¸ªå®¹å™¨éšå³è¢«ç§»åŠ¨åˆ°ä¸€ä¸ªå¯¹è±¡çš„æ•°æ®æˆå‘˜ä¸Šï¼Œè¯¥å¯¹è±¡éšåå³è¢«é”€æ¯ã€‚å½“è¯¥å¯¹è±¡è¢«é”€æ¯åï¼Œè¯¥å¯¹è±¡çš„`std::unique_ptr`æ•°æ®æˆå‘˜ä¹Ÿéšå³è¢«é”€æ¯ï¼Œå®ƒçš„ææ„ä¼šå¼•å‘å·¥å‚è¿”å›çš„èµ„æºè¢«é”€æ¯ã€‚å¦‚æœæ‹¥æœ‰é“¾å› ä¸ºå¼‚å¸¸æˆ–è€…å…¶ä»–çš„å¼‚å¸¸æ§åˆ¶æµ(å¦‚ï¼Œå‡½æ•°è¿‡æ—©è¿”å›æˆ–è€…forå¾ªç¯ä¸­çš„breakè¯­å¥)ä¸­æ–­ï¼Œæœ€ç»ˆæ‹¥æœ‰èµ„æºçš„`std::unique_ptr`ä»ä¼šè°ƒç”¨å®ƒçš„ææ„å‡½æ•°(æ³¨è§£ï¼šè¿™æ¡è§„åˆ™ä»æœ‰ä¾‹å¤–ï¼šå¤§å¤šæ•°æºè‡ªäºç¨‹åºçš„éæ­£å¸¸ä¸­æ–­ã€‚ä¸€ä¸ªä»ä¸€ä¸ªçº¿ç¨‹ä¸»å‡½æ•°(å¦‚ç¨‹åºçš„åˆå§‹çº¿ç¨‹çš„mainå‡½æ•°)ä¼ é€’å‡ºæ¥çš„å¼‚å¸¸ï¼Œæˆ–è€…ä¸€ä¸ªè¿èƒŒäº†noexpectè§„èŒƒ(è¯·çœ‹Item 14)çš„å¼‚å¸¸,æœ¬åœ°å¯¹è±¡ä¸ä¼šå¾—åˆ°ææ„ï¼Œå¦‚æœ`std::abort`æˆ–è€…å…¶ä»–çš„exitå‡½æ•°(å¦‚`std::_Exit`, `std::exit`,æˆ–è€…`std::quick_exit`)è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå®ƒä»¬è‚¯å®šä¸ä¼šè¢«ææ„)ï¼Œ`std::unique_ptr`ç®¡ç†çš„èµ„æºä¹Ÿå› æ­¤å¾—åˆ°é‡Šæ”¾ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œææ„å‡½æ•°ä¼šä½¿ç”¨deleteã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å®ƒçš„æ„é€ è¿‡ç¨‹ä¸­æŒ‡å®šç‰¹å®šçš„ææ„æ–¹æ³•(custom deleters):å½“èµ„æºè¢«å›æ”¶æ—¶ï¼Œä¼ å…¥çš„ç‰¹å®šçš„ææ„æ–¹æ³•(å‡½æ•°å¯¹è±¡ï¼Œæˆ–è€…æ˜¯ç‰¹å®šçš„lambdaè¡¨è¾¾å¼)ä¼šè¢«è°ƒç”¨ã€‚å¯¹äºæˆ‘ä»¬çš„ä¾‹å­æ¥è¯´ï¼Œå¦‚æœè¢«makeInvestmentåˆ›å»ºçš„å¯¹è±¡ä¸åº”è¯¥ç›´æ¥è¢«deletedï¼Œè€Œæ˜¯é¦–å…ˆè¦æœ‰ä¸€æ¡logè®°å½•ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·å®ç°makeInvestmentï¼ˆå½“ä½ çœ‹åˆ°æ„å›¾ä¸æ˜¯å¾ˆæ˜æ˜¾çš„ä»£ç æ—¶ï¼Œè¯·æ³¨æ„çœ‹æ³¨é‡Šï¼‰

```cpp
auto delInvmt = [](Investment* pInvestment){
	makeLogEntry(pInvestment);
	delete pInvestment;
};//custom deleter(a lambda expression)
template<typename... Ts>
std::unique_ptr<Investment, decltype(delInvmt)>//revised return type
makeInvestment(Ts&&... params)
{
	std::unique_ptr<Investment, decltype(delInvmt)> pInv(nullptr, delInvmt);//ptr to be returned
	if ( /* a Stock object should be created */ )
	{
       pInv.reset(new Stock(std::forward<Ts>(params)...));
    }
    else if ( /* a Bond object should be created */ )
    {
       pInv.reset(new Bond(std::forward<Ts>(params)...));
    }
    else if ( /* a RealEstate object should be created */ )
    {
       pInv.reset(new RealEstate(std::forward<Ts>(params)...));
    }
    return pInv;
}
```
æˆ‘ä¹‹å‰è¯´è¿‡ï¼Œå½“ä½¿ç”¨é»˜è®¤çš„ææ„æ–¹æ³•æ—¶(å³ï¼Œdelete)ï¼Œä½ å¯ä»¥å‡è®¾`std::unique_ptr`å¯¹è±¡çš„å¤§å°å’ŒåŸç”ŸæŒ‡é’ˆä¸€æ ·ã€‚å½“`std::unique_ptr`ç”¨åˆ°äº†è‡ªå®šä¹‰çš„deleteræ—¶ï¼Œæƒ…å†µå¯å°±ä¸ä¸€æ ·äº†ã€‚å‡½æ•°æŒ‡é’ˆç±»å‹çš„deleterä¼šä½¿å¾—`std::unique_ptr`çš„å¤§å°å¢é•¿åˆ°ä¸€ä¸ªå­—èŠ‚åˆ°ä¸¤ä¸ªå­—èŠ‚ã€‚å¯¹äºdeletersæ˜¯å‡½æ•°å¯¹è±¡çš„`std::unique_ptr`,å¤§å°çš„æ”¹å˜ä¾èµ–äºå‡½æ•°å¯¹è±¡å†…éƒ¨è¦å­˜å‚¨å¤šå°‘çŠ¶æ€ã€‚æ— çŠ¶æ€çš„å‡½æ•°å¯¹è±¡(å¦‚ï¼Œæ²¡æœ‰capturesçš„lambda expressions) ä¸ä¼šå¯¼è‡´é¢å¤–çš„å¤§å°å¼€é”€ã€‚è¿™å°±æ„å‘³ç€å½“ä¸€ä¸ªè‡ªå®šä¹‰çš„deleteræ—¢å¯ä»¥å®ç°ä¸ºä¸€ä¸ªå‡½æ•°å¯¹è±¡æˆ–è€…ä¸€ä¸ªæ— æ•è·çŠ¶æ€çš„lambdaè¡¨è¾¾å¼æ—¶ï¼Œlambdaæ˜¯ç¬¬ä¸€ä¼˜å…ˆé€‰æ‹©:

```cpp
auto delInvmt1 = [](Investment* pInvestment)
				{	
					makeLogEntry(pInvestment);
					delete pInvestment;
				}
//custom deleter as stateless lambda
template<typename... Ts>
std::unique_ptr<Investment, decltype(delInvmt1)>
makeInvestment(Ts&&.. args);//return type has size of Investment*

void delInvmt2(Investment* pInvestment)
{
	makeLogEntry(pInvestment);
	delete pInvestment;
}

template<typename... Ts>
std::unique_ptr<Investment,(void *)(Investment*)>
makeInvestment(Ts&&... params);//return type has size of Investment* plus at least size of function pointer!
```
å¸¦æœ‰è¿‡å¤šçŠ¶æ€çš„å‡½æ•°å¯¹è±¡çš„deletersæ˜¯ä½¿å¾—`std::unique_ptr`çš„å¤§å°å¾—åˆ°æ˜¾è‘—çš„å¢åŠ ã€‚å¦‚æœä½ å‘ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„deleterä½¿å¾—ä½ çš„`std::unique_ptr`å¤§åˆ°æ— æ³•æ¥å—ï¼Œè¯·è€ƒè™‘é‡æ–°æ”¹å˜ä½ çš„è®¾è®¡ã€‚

`std::unique_ptr`ä¼šäº§ç”Ÿä¸¤ç§æ ¼å¼ï¼Œä¸€ç§æ˜¯ç‹¬ç«‹çš„å¯¹è±¡(std::unique_ptr<T>)ï¼Œå¦å¤–ä¸€ç§æ˜¯æ•°ç»„(`std::unique_ptr<T[]>`).å› æ­¤ï¼Œstd::unique_ptræŒ‡å‘çš„å†…å®¹ä»æ¥ä¸ä¼šäº§ç”Ÿä»»ä½•æ­§ä¹‰æ€§ã€‚å®ƒçš„APIæ˜¯ä¸“é—¨ä¸ºäº†ä½ ä½¿ç”¨çš„æ ¼å¼æ¥è®¾è®¡çš„.ä¾‹å¦‚ï¼Œå•å¯¹è±¡æ ¼å¼ä¸­æ²¡æœ‰è¿‡ç´¢å¼•æ“ä½œç¬¦(æ“ä½œç¬¦[]),æ•°ç»„æ ¼å¼åˆ™æ²¡æœ‰è§£å¼•ç”¨æ“ä½œç¬¦(æ“ä½œç¬¦*å’Œæ“ä½œç¬¦->)

`std::unique_ptr`çš„æ•°ç»„æ ¼å¼å¯¹ä½ æ¥è¯´å¯èƒ½æ˜¯åè€Œä¸å®çš„ä¸œä¸œï¼Œå› ä¸ºå’ŒåŸç”Ÿçš„arrayç›¸æ¯”ï¼Œ`std::array`,`std::vector`ä»¥åŠ`std::string`å‡ ä¹æ˜¯æ›´å¥½çš„æ•°æ®ç»“æ„é€‰æ‹©ã€‚æˆ‘æ‰€æƒ³åˆ°çš„å”¯ä¸€çš„std::unique_ptr<T[]>æœ‰æ„ä¹‰çš„ä½¿ç”¨åœºæ™¯æ˜¯ï¼Œä½ ä½¿ç”¨äº†C-like APIæ¥è¿”å›ä¸€ä¸ªæŒ‡å‘å †å†…åˆ†é…çš„æ•°ç»„çš„åŸç”ŸæŒ‡é’ˆï¼Œè€Œä¸”ä½ åƒå¯¹ä¹‹æ¥ç®¡æ‹¥æœ‰æƒã€‚

C++11ä½¿ç”¨`std::unique_ptr`æ¥è¡¨è¿°ç‹¬å æ‰€æœ‰æƒã€‚ä½†æ˜¯å®ƒçš„ä¸€é¡¹æœ€å¼•äººæ³¨ç›®çš„ç‰¹æ€§å°±æ˜¯å®ƒå¯ä»¥è½»æ˜“ä¸”æœ‰æ•ˆçš„è½¬åŒ–ä¸º`std::shared_ptr`:

```cpp
std::shared_ptr<Investment> sp = makeInvestment(arguments);//converts std::unique_ptr to std::shared_ptr
```

è¿™å°±æ˜¯`std::unique_ptr`å¾ˆé€‚åˆä½œä¸ºå·¥å‚å‡½æ•°è¿”å›å€¼ç±»å‹çš„åŸå› ã€‚å·¥å‚å‡½æ•°ä¸çŸ¥é“è°ƒç”¨è€…æƒ³ä½¿ç”¨ç‹¬å æ€§çš„æ‹¥æœ‰è¯­ä¹‰è¿˜æ˜¯å…±äº«å¼çš„æ‹¥æœ‰è¯­ä¹‰(å³`std::share_ptr`).é€šè¿‡è¿”å›`std::unique_ptr`,å·¥å‚å‡½æ•°å°†é€‰æ‹©æƒç§»äº¤ç»™äº†è°ƒç”¨è€…,è°ƒç”¨è€…åœ¨éœ€è¦çš„æ—¶å€™å¯ä»¥å°†`std::unique_ptr`è½¬åŒ–ä¸ºå®ƒæœ€å¯Œæœ‰çµæ´»æ€§çš„å…„å¼Ÿ(å¦‚æœæƒ³äº†è§£æ›´å¤šå…³äº`std::shared_ptr`,è¯·ç§»æ­¥Item 19)

|è¦è®°ä½çš„ä¸œè¥¿|
|:--------- |
|`std::unique_ptr`æ˜¯ä¸€ä¸ªå…·æœ‰å¼€é”€å°ï¼Œé€Ÿåº¦å¿«ï¼Œ`move-only`ç‰¹å®šçš„æ™ºèƒ½æŒ‡é’ˆï¼Œä½¿ç”¨ç‹¬å æ‹¥æœ‰æ–¹å¼æ¥ç®¡ç†èµ„æºã€‚|
|é»˜è®¤æƒ…å†µä¸‹ï¼Œé‡Šæ”¾èµ„æºç”±deleteæ¥å®Œæˆï¼Œä¹Ÿå¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çš„ææ„å‡½æ•°æ¥æ›¿ä»£ã€‚ä½†æ˜¯å…·æœ‰ä¸°å¯ŒçŠ¶æ€çš„deleterså’Œä»¥å‡½æ•°æŒ‡é’ˆä½œä¸ºdeleterså¢å¤§äº†`std::unique_ptr`çš„å­˜å‚¨å¼€é”€|
|å¾ˆå®¹æ˜“å°†ä¸€ä¸ª`std::unique_ptr`è½¬åŒ–ä¸º`std::shared_ptr`|

